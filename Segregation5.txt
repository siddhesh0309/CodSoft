import pandas as pd
import os
from openpyxl import load_workbook

# File paths
template_file = "template.xlsm"
mapping_file = "mapping.xlsx"
output_folder = "segregated_occupation_files"

# Step 1: Load template headers from row 4, data from row 9
print("üîÑ Loading template data from row 9 (headers in row 4)...")
df_full = pd.read_excel(template_file, sheet_name="Account Holder", header=3, engine="openpyxl")
df = df_full.iloc[5:].reset_index(drop=True)

# Step 2: Load mapping file
print("üîÑ Loading mapping file...")
df_mapping = pd.read_excel(mapping_file)

# Step 3: Merge mapping (Occupation, GHO Code, Status of Account)
df = df.merge(df_mapping[["Account Number", "Occupation", "GHO Code", "Status of Account"]],
              on="Account Number", how="left", suffixes=("", "_mapped"))

# Step 4: TIN columns setup
tin_columns = ["Foreign_TIN"] + [f"Foreign_TIN{i}" for i in range(2, 9)]
tin_country_columns = ["TIN_Issuing_Country"] + [f"TIN_Issuing_Country{i}" for i in range(2, 9)]
tin_columns = [col for col in tin_columns if col in df.columns]
tin_country_columns = [col for col in tin_country_columns if col in df.columns]

# Step 5: Final occupation logic
def determine_final_occupation(row):
    occ_map = str(row.get("Occupation_mapped", "")).strip()
    gho = str(row.get("GHO Code_mapped", "")).strip().upper()

    # 1. Sea Fearer logic
    if occ_map == "" or occ_map.lower() == "sea fearer":
        all_dummy_or_blank = all(
            pd.isna(row.get(col)) or row.get(col) == "AAAAAAAAA" for col in tin_columns
        )
        if all_dummy_or_blank:
            return "Sea Fearer"

    # 2. Blank if SC = Y and valid non-IN TIN exists
    if row.get("SC") == "Y":
        for tin_col, country_col in zip(tin_columns, tin_country_columns):
            if pd.notna(row.get(tin_col)) and row[tin_col] != "AAAAAAAAA":
                if pd.notna(row.get(country_col)) and row[country_col] != "IN":
                    return ""

    # 3. Dependent logic
    occ_check = occ_map.lower()
    if occ_check in ["housewife", "student", "minor account"]:
        return "Dependent"
    if gho in ["MRS", "PBM"]:
        return "Dependent"

    # 4. Default to mapped occupation
    return occ_map

df["Occupation_final"] = df.apply(determine_final_occupation, axis=1)

# Step 6: Load template for writing back
print("‚úçÔ∏è Opening template to write updated values...")
wb = load_workbook(template_file, keep_vba=True)
ws = wb["Account Holder"]

# Step 7: Ensure required columns exist in row 4
required_columns = ["Occupation", "GHO Code", "Status of Account"]
header_row = 4
headers = [cell.value for cell in ws[header_row]]
col_map = {}

for col_name in required_columns:
    if col_name in headers:
        col_map[col_name] = headers.index(col_name) + 1
    else:
        # Add new column at the end
        new_col_index = len(headers) + 1
        ws.cell(row=header_row, column=new_col_index).value = col_name
        col_map[col_name] = new_col_index
        headers.append(col_name)
        print(f"‚ûï Added missing column: {col_name} at position {new_col_index}")

# Step 8: Write only the 3 columns from row 9 onward
for i, row in enumerate(df.itertuples(index=False), start=9):
    ws.cell(row=i, column=col_map["Occupation"], value=row.Occupation_final)
    ws.cell(row=i, column=col_map["GHO Code"], value=row._asdict().get("GHO Code_mapped"))
    ws.cell(row=i, column=col_map["Status of Account"], value=row._asdict().get("Status of Account_mapped"))

wb.save(template_file)
print(f"‚úÖ Template updated successfully: {template_file}")

# Step 9: Create segregated files by Occupation
os.makedirs(output_folder, exist_ok=True)
print("üìÇ Creating segregated files by Occupation...")

df["Occupation_final"] = df["Occupation_final"].fillna("").astype(str)
for occupation, group in df.groupby("Occupation_final"):
    safe_name = occupation if occupation.strip() else "Unknown"
    safe_name = safe_name.replace(" ", "_").replace("/", "_")
    filename = f"{output_folder}/{safe_name}_accounts.xlsx"
    group.to_excel(filename, index=False)
    print(f"‚úÖ Saved: {filename}")

print("üéØ Process completed successfully.")
